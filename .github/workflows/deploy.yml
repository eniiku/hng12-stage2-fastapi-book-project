name: deploy

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    if: github.event.pull_request.merged == true # Only run if the PR was merged
    runs-on: ubuntu-latest

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332" # actions/checkout@v4

      - name: Set up SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd hng12-stage2-fastapi-book-project/
            git pull origin main
            sudo docker build -t fastapi-app .
            sudo docker stop fastapi-app || true
            sudo docker rm fastapi-app || true
            sudo docker run -d --name fastapi-app -p 8000:8000 fastapi-app

            # Copy the nginx.conf file to the VM
            sudo cp ./nginx.conf /etc/nginx/sites-available/default

            # Test the Nginx configuration
            sudo nginx -t

            # Reload Nginx to apply the new configuration
            sudo systemctl reload nginx
